<!doctype html>
<script>
  // Password gate sederhana (bukan security kuat)
  const PASS = "ipamawell"; 
  const key = "ipama_gate_ok";

  if (localStorage.getItem(key) !== "1") {
    const p = prompt("Masukkan password untuk akses halaman:");
    if (p === PASS) {
      localStorage.setItem(key, "1");
      location.reload();
    } else {
      document.documentElement.innerHTML = "<h2>Akses ditolak</h2>";
      throw new Error("blocked");
    }
  }
</script>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IPAMA - Daftar & List Anggota</title>
  <style>
    :root{--bg:#0b1020;--card:#121a33;--text:#e9edff;--muted:#b7c0ff;--danger:#ff6b6b;--ok:#2ecc71;--border:rgba(255,255,255,.12)}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:radial-gradient(1200px 600px at 10% 0%,#17204a 0%,var(--bg) 55%);color:var(--text)}
    header{padding:20px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;backdrop-filter:blur(10px);background:rgba(11,16,32,.75);z-index:10}
    .wrap{max-width:1100px;margin:0 auto}
    .row{display:grid;gap:16px}
    @media (min-width:960px){.row{grid-template-columns:1.2fr 1.8fr}}
    h1{font-size:18px;margin:0;letter-spacing:.4px}
    .sub{color:var(--muted);font-size:12px;margin-top:6px}
    main{padding:18px 16px 40px}
    .card{background:rgba(18,26,51,.78);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 12px 30px rgba(0,0,0,.28)}
    .card h2{margin:0 0 12px;font-size:14px;color:#d8e2ff}
    .grid{display:grid;gap:10px;grid-template-columns:1fr}
    @media (min-width:560px){.grid.two{grid-template-columns:1fr 1fr}}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);outline:none}
    textarea{min-height:86px;resize:vertical}
    button{appearance:none;border:1px solid var(--border);background:rgba(255,255,255,.08);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:600}
    button.primary{border-color:rgba(110,168,255,.6);background:rgba(110,168,255,.18)}
    button.danger{border-color:rgba(255,107,107,.55);background:rgba(255,107,107,.12)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--border);color:var(--muted);font-size:12px}
    .pill b{color:var(--text);font-weight:700}
    table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:12px}
    th,td{padding:10px;border-bottom:1px solid var(--border);vertical-align:top;font-size:13px}
    th{text-align:left;font-size:12px;color:var(--muted);font-weight:700}
    .muted{color:var(--muted)}
    .status{font-size:12px;margin-top:10px}
    .status.ok{color:var(--ok)}
    .status.err{color:var(--danger)}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:18px;background:rgba(0,0,0,.55);z-index:20}
    .modal.on{display:flex}
    .modal .box{width:min(560px,100%)}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>IPAMA â€” Daftar & List Anggota</h1>
      <div class="sub">IKATAN MAHASISWA PECINTA ALAM GEMA</div>
    </div>
  </header>

  <main>
    <div class="wrap row">
      <section class="card">
        <div class="toolbar">
          <h2>Form Pendaftaran Anggota</h2>
          <span id="adminBadge" class="pill">Mode: <b>Publik</b></span>
        </div>

        <form id="regForm" class="grid" autocomplete="off">
          <div>
            <label>Nama</label>
            <input name="nama" required placeholder="Nama lengkap" />
          </div>

          <div class="grid two">
            <div>
              <label>No WhatsApp (hanya admin yang bisa lihat)</label>
              <input name="no_wa" inputmode="tel" placeholder="08xxxxxxxxxx" />
            </div>
            <div>
              <label>Prodi</label>
              <input name="prodi" required placeholder="Contoh: Teknik Informatika" />
            </div>
          </div>

          <div class="grid two">
            <div>
              <label>Kelas</label>
              <input name="kelas" required placeholder="Contoh: TI-3A" />
            </div>
            <div>
              <label>Alamat (hanya admin yang bisa lihat)</label>
              <input name="alamat" placeholder="Alamat" />
            </div>
          </div>

          <div>
            <label>Alasan ikut IPAMA (hanya admin yang bisa lihat)</label>
            <textarea name="alasan" placeholder="Tulis alasan singkat..."></textarea>
          </div>

          <div class="toolbar">
            <button class="primary" type="submit">Daftar</button>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button type="button" id="btnRefresh">Refresh List</button>
              <button type="button" id="btnAdmin">Login Admin</button>
              <button type="button" id="btnLogout" style="display:none;">Logout</button>
            </div>
          </div>

          <div id="regStatus" class="status"></div>
        </form>

        <div id="apiBox" class="card" style="margin-top:14px; display:none;">
          <h2>Set API URL (1x)</h2>
          <div class="muted" style="margin-bottom:10px;">JSONP tidak bisa dimuat dari URL saat ini. Paste URL final yang **script.googleusercontent.com** (hasil redirect) lalu simpan.</div>
          <div class="grid">
            <div>
              <label>API_URL</label>
              <input id="apiInput" placeholder="https://script.googleusercontent.com/.../exec" />
            </div>
            <button id="apiSave" class="primary" type="button">Simpan API URL</button>
            <div class="muted">Setelah disimpan, refresh halaman.</div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="toolbar" style="margin-bottom:10px;">
          <h2>List Anggota</h2>
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <input id="search" placeholder="Cari nama/prodi/kelas..." style="min-width: 240px;" />
            <button id="btnExport" class="primary" style="display:none;">Export CSV (Admin)</button>
          </div>
        </div>

        <div class="muted" id="count"></div>
        <div style="overflow:auto; border:1px solid var(--border); border-radius:12px; margin-top:10px;">
          <table>
            <thead><tr id="thead"></tr></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <div id="listStatus" class="status"></div>
      </section>
    </div>
  </main>

  <div id="modal" class="modal" aria-hidden="true">
    <div class="box card">
      <div class="toolbar">
        <h2 id="modalTitle">Admin</h2>
        <button id="modalClose">Tutup</button>
      </div>
      <div id="modalBody"></div>
      <div id="modalStatus" class="status"></div>
    </div>
  </div>

<script>
  // Default URL (bisa gagal untuk JSONP di beberapa browser). Kalau gagal, web akan minta URL final googleusercontent.
  const DEFAULT_API_URL = 'https://script.google.com/macros/s/AKfycbzCWZp4Q0pZf1w7KEyAMI2Mv09XIClxcvYHpJR7_gWMYrx2V1YgcjiJoBsdPsKyp7st/exec';

  const API_STORAGE_KEY = 'ipama_api_url_v1';
  let API_URL = localStorage.getItem(API_STORAGE_KEY) || DEFAULT_API_URL;

  let adminPassword = '';
  let isAdmin = false;
  let members = [];

  const regForm = document.getElementById('regForm');
  const regStatus = document.getElementById('regStatus');
  const listStatus = document.getElementById('listStatus');
  const btnRefresh = document.getElementById('btnRefresh');
  const btnAdmin = document.getElementById('btnAdmin');
  const btnLogout = document.getElementById('btnLogout');
  const adminBadge = document.getElementById('adminBadge');
  const btnExport = document.getElementById('btnExport');
  const search = document.getElementById('search');
  const thead = document.getElementById('thead');
  const tbody = document.getElementById('tbody');
  const count = document.getElementById('count');

  const apiBox = document.getElementById('apiBox');
  const apiInput = document.getElementById('apiInput');
  const apiSave = document.getElementById('apiSave');

  const modal = document.getElementById('modal');
  const modalTitle = document.getElementById('modalTitle');
  const modalBody = document.getElementById('modalBody');
  const modalStatus = document.getElementById('modalStatus');
  const modalClose = document.getElementById('modalClose');

  function setStatus(el, msg, ok=true){
    el.textContent = msg || '';
    el.className = 'status ' + (msg ? (ok ? 'ok' : 'err') : '');
  }

  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // ===== JSONP (dengan cache-buster + error detail) =====
  function jsonp(params){
    return new Promise((resolve, reject) => {
      const cb = '__ipama_cb_' + Math.random().toString(36).slice(2);
      params.callback = cb;
      params._ts = Date.now();

      const url = new URL(API_URL);
      Object.keys(params).forEach(k => {
        if (params[k] !== undefined && params[k] !== null) url.searchParams.set(k, String(params[k]));
      });

      const script = document.createElement('script');
      script.async = true;

      const timeout = setTimeout(() => {
        cleanup();
        reject(new Error('Timeout: callback tidak terpanggil. URL: ' + url.toString()));
      }, 20000);

      function cleanup(){
        clearTimeout(timeout);
        delete window[cb];
        script.remove();
      }

      window[cb] = (data) => {
        cleanup();
        resolve(data);
      };

      script.onerror = () => {
        cleanup();
        reject(new Error('Gagal memuat JSONP. URL: ' + url.toString()));
      };

      script.src = url.toString();
      document.body.appendChild(script);
    });
  }

  function showApiBox(urlTried){
    apiBox.style.display = 'block';
    apiInput.value = localStorage.getItem(API_STORAGE_KEY) || '';
    setStatus(regStatus, 'Koneksi API gagal. Silakan set API URL final (script.googleusercontent.com) lalu refresh.', false);
    setStatus(listStatus, 'JSONP gagal dimuat dari: ' + urlTried, false);
  }

  apiSave.onclick = () => {
    const v = apiInput.value.trim();
    if (!v) return;
    localStorage.setItem(API_STORAGE_KEY, v);
    API_URL = v;
    location.reload();
  };

  function updateAdminUI(){
    if (isAdmin){
      adminBadge.innerHTML = 'Mode: <b>Admin</b>';
      btnAdmin.style.display = 'none';
      btnLogout.style.display = 'inline-block';
      btnExport.style.display = 'inline-block';
    } else {
      adminBadge.innerHTML = 'Mode: <b>Publik</b>';
      btnAdmin.style.display = 'inline-block';
      btnLogout.style.display = 'none';
      btnExport.style.display = 'none';
    }
  }

  async function loadMembers(){
    const res = await jsonp(adminPassword ? { password: adminPassword } : {});
    if (!res.ok) throw new Error(res.error || 'Gagal mengambil data');
    isAdmin = !!res.isAdmin;
    updateAdminUI();
    return res.data || [];
  }

  async function createMember(payload){
    const res = await jsonp({ action:'create', ...payload });
    if (!res.ok) throw new Error(res.error || 'Gagal daftar');
    return res;
  }

  async function updateMember(id, payload){
    const res = await jsonp({ action:'update', password: adminPassword, id, ...payload });
    if (!res.ok) throw new Error(res.error || 'Gagal update');
    return res;
  }

  async function deleteMember(id){
    const res = await jsonp({ action:'delete', password: adminPassword, id });
    if (!res.ok) throw new Error(res.error || 'Gagal hapus');
    return res;
  }

  function render(rows){
    const publicCols=[
      {key:'tanggal_daftar',label:'Tanggal'},
      {key:'nama',label:'Nama'},
      {key:'prodi',label:'Prodi'},
      {key:'kelas',label:'Kelas'},
    ];
    const adminCols=publicCols.concat([
      {key:'no_wa',label:'No WA'},
      {key:'alamat',label:'Alamat'},
      {key:'alasan',label:'Alasan'},
    ]);

    const cols = isAdmin ? adminCols : publicCols;

    thead.innerHTML = cols.map(c=>`<th>${escapeHtml(c.label)}</th>`).join('') + (isAdmin?'<th>Aksi</th>':'');

    tbody.innerHTML = rows.map(r=>{
      const tds = cols.map(c=>{
        let v=r[c.key];
        if (c.key==='tanggal_daftar'){
          const s=String(v??'');
          v=s?s.replace('T',' ').slice(0,16):'';
        }
        return `<td>${escapeHtml(v)}</td>`;
      }).join('');

      const actions = isAdmin ? `
        <td style="white-space:nowrap;">
          <button data-act="edit" data-id="${escapeHtml(r.id)}">Edit</button>
          <button class="danger" data-act="del" data-id="${escapeHtml(r.id)}">Hapus</button>
        </td>` : '';

      return `<tr>${tds}${actions}</tr>`;
    }).join('');

    count.textContent = `Total: ${rows.length} anggota`;
  }

  function filtered(){
    const q = search.value.trim().toLowerCase();
    if (!q) return members;
    return members.filter(m=>{
      const s = [m.nama,m.prodi,m.kelas].map(x=>String(x??'').toLowerCase()).join(' ');
      return s.includes(q);
    });
  }

  async function refresh(){
    try{
      setStatus(listStatus,'Memuat data...',true);
      members = await loadMembers();
      render(filtered());
      setStatus(listStatus,'',true);
    }catch(e){
      showApiBox(API_URL);
    }
  }

  // ===== Modal admin =====
  function openModal(title, html){
    modalTitle.textContent=title;
    modalBody.innerHTML=html;
    modalStatus.textContent='';
    modalStatus.className='status';
    modal.classList.add('on');
    modal.setAttribute('aria-hidden','false');
  }
  function closeModal(){
    modal.classList.remove('on');
    modal.setAttribute('aria-hidden','true');
  }

  function showAdminLogin(){
    openModal('Login Admin', `
      <div class="grid">
        <div>
          <label>Password Admin</label>
          <input id="adminPass" type="password" placeholder="Masukkan password" />
        </div>
        <button class="primary" id="doLogin">Login</button>
        <div class="muted">Fitur admin: lihat privat, edit, hapus, export CSV.</div>
      </div>`);

    document.getElementById('doLogin').onclick = async ()=>{
      adminPassword = document.getElementById('adminPass').value.trim();
      try{
        await refresh();
        if (!isAdmin){
          adminPassword='';
          updateAdminUI();
          setStatus(modalStatus,'Password salah.',false);
          return;
        }
        closeModal();
      }catch(e){
        adminPassword='';
        updateAdminUI();
        setStatus(modalStatus,'Error koneksi API. Set API URL dulu.',false);
      }
    };
  }

  function showEditModal(id){
    const m = members.find(x=>x.id===id);
    if (!m) return;

    openModal('Edit Anggota (Admin)', `
      <div class="grid">
        <div class="grid two">
          <div>
            <label>Nama</label>
            <input id="e_nama" value="${escapeHtml(m.nama)}" />
          </div>
          <div>
            <label>No WA</label>
            <input id="e_no_wa" value="${escapeHtml(m.no_wa)}" />
          </div>
        </div>
        <div class="grid two">
          <div>
            <label>Prodi</label>
            <input id="e_prodi" value="${escapeHtml(m.prodi)}" />
          </div>
          <div>
            <label>Kelas</label>
            <input id="e_kelas" value="${escapeHtml(m.kelas)}" />
          </div>
        </div>
        <div>
          <label>Alamat</label>
          <input id="e_alamat" value="${escapeHtml(m.alamat)}" />
        </div>
        <div>
          <label>Alasan</label>
          <textarea id="e_alasan">${escapeHtml(m.alasan)}</textarea>
        </div>
        <button class="primary" id="doSave">Simpan</button>
      </div>`);

    document.getElementById('doSave').onclick = async ()=>{
      try{
        setStatus(modalStatus,'Menyimpan...',true);
        await updateMember(id, {
          nama: document.getElementById('e_nama').value,
          no_wa: document.getElementById('e_no_wa').value,
          prodi: document.getElementById('e_prodi').value,
          kelas: document.getElementById('e_kelas').value,
          alamat: document.getElementById('e_alamat').value,
          alasan: document.getElementById('e_alasan').value,
        });
        await refresh();
        closeModal();
      }catch(e){
        setStatus(modalStatus,'Error koneksi API. Pastikan API_URL sudah benar.',false);
      }
    };
  }

  // Export CSV
  function toCSV(rows, cols){
    const esc=(v)=>{const s=String(v??''); return /[\",\n]/.test(s)?'"'+s.replace(/\"/g,'""')+'"':s};
    return cols.join(',')+'\n'+rows.map(r=>cols.map(c=>esc(r[c])).join(',')).join('\n');
  }
  function download(name, content, mime){
    const blob=new Blob([content],{type:mime||'text/plain'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);
  }

  document.getElementById('btnRefresh').onclick = refresh;
  document.getElementById('btnAdmin').onclick = showAdminLogin;
  document.getElementById('btnLogout').onclick = ()=>{adminPassword='';isAdmin=false;updateAdminUI();refresh();};

  modalClose.onclick = closeModal;
  modal.addEventListener('click', (e)=>{ if(e.target===modal) closeModal(); });

  search.addEventListener('input', ()=>render(filtered()));

  regForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd=new FormData(regForm);
    const payload=Object.fromEntries(fd.entries());
    try{
      setStatus(regStatus,'Mengirim...',true);
      await createMember(payload);
      regForm.reset();
      setStatus(regStatus,'Berhasil daftar!',true);
      await refresh();
    }catch(err){
      showApiBox(API_URL);
    }
  });

  tbody.addEventListener('click', async (e)=>{
    const btn=e.target.closest('button');
    if(!btn) return;
    const act=btn.getAttribute('data-act');
    const id=btn.getAttribute('data-id');

    if (act==='edit') return showEditModal(id);

    if (act==='del'){
      if(!confirm('Yakin hapus anggota ini?')) return;
      try{
        setStatus(listStatus,'Menghapus...',true);
        await deleteMember(id);
        await refresh();
        setStatus(listStatus,'Terhapus.',true);
      }catch(err){
        showApiBox(API_URL);
      }
    }
  });

  btnExport.addEventListener('click', ()=>{
    if(!isAdmin) return;
    const cols=['tanggal_daftar','nama','no_wa','prodi','kelas','alamat','alasan'];
    const csv=toCSV(members, cols);
    const d=new Date();
    const stamp=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    download(`ipama-anggota-${stamp}.csv`, csv, 'text/csv');
  });

  updateAdminUI();
  refresh();
</script>
</body>
</html>
